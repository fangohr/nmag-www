WEBSERVER=nmag.soton.ac.uk
INST_MANUALDIR=tmp/installation-manual
DATE=$(shell date +%Y-%m-%d-T%H-%M-%S)

# Note: this variable can and will be overridden via "make NSIM_VERSION=0.1 all".

NSIM_VERSION=devel
NSIM_BRANCH=$(patsubst branches/devel,trunk,branches/$(NSIM_VERSION))
DEBVERSION=$(NSIM_VERSION:devel=0.9999)
SRCDIR=nsim-src-$(NSIM_VERSION)

#all: tarballs html-toplevel current-link debian-package

all: html-toplevel current-link debian-package

# === KNOWN VERSIONS ===

devel:
	make -f Makefile-tf NSIM_VERSION=devel all

# Experimental branch to test this version-aware build system:
0.099:
	make -f Makefile-tf NSIM_VERSION=0.099 all


# Does not exist yet:
0.1:
	make -f Makefile-tf NSIM_VERSION=0.1 all

# === /KNOWN VERSIONS ===

mrproper:
	rm -rf tmp/*
	rm -rf webserver-webroot/*

webroot: all
	mkdir webserver-webroot || /bin/true # ensure it exists
	rsync -auv --exclude .svn output/* webserver-webroot/nmag/
	rsync -auv --exclude Makefile debian/web/debian/ webserver-webroot/debian/


# This introduces the link current -> [current version]:

current-link:
	rm -f output/current
	cd output; ln -s 0.1 current


# This builds the "outer" HTML structure which contains general
# explanations on installation, etc.  plus links to the individual
# versions:

html-toplevel: manuals
	cat input/0.1/install/_a_index input/0.1/install/_a_INSTALL > input/0.1/install/install_a.txt
	cd input; r2w

installation-manual:
	mkdir -p tmp/installation-manual
	cd tmp; svn co svn+ssh://alpha.kk.soton.ac.uk/var/local/svn/nsimdist/$(NSIM_BRANCH) installation-manual
	cd tmp/installation-manual/doc/installation_manual; make

nsim:
	cd tmp; svn co svn+ssh://alpha.kk.soton.ac.uk/var/local/svn/nsim/$(NSIM_BRANCH) nsim
	cd tmp/nsim; make all doc


fetchtrunk:
	#This is used for the creation of the tar file
	echo "About to do a clean checkout from the repository (trunk) for the distribution."
	cd tmp; svn co svn+ssh://alpha.kk.soton.ac.uk/var/local/svn/nsimdist/trunk/ $(SRCDIR)
	mkdir -p tmp/$(SRCDIR)/nsim
	cd tmp/$(SRCDIR); svn co svn+ssh://alpha.kk.soton.ac.uk/var/local/svn/nsim/$(NSIM_BRANCH) nsim
	cd tmp/$(SRCDIR)/nsim; svnversion > ../../../input/$(NSIM_VERSION)/svnversion


tarballs: fetchtrunk installation-manual nsim
	#create links for nmag manual into toplevel 'doc' dir
	mkdir -p output/$(NSIM_VERSION)/download
	rm -f tmp/$(SRCDIR)/doc/nmag
	cd tmp/$(SRCDIR)/doc; ln -s nsim/interface/nmag/manual nmag
	cd tmp; tar --exclude=\\.svn -cvzf ../output/$(NSIM_VERSION)/download/nmag-$(NSIM_VERSION)-core.tar.gz $(SRCDIR)/nsim

	#copy compiled nmag manual
	rsync -auv --delete tmp/nsim/interface/nmag/manual/* tmp/$(SRCDIR)/nsim/interface/nmag/manual

	#copy (compiled) installation manual
	rsync -auv --delete $(INST_MANUALDIR)/INSTALL tmp/$(SRCDIR)
	rsync -auv --delete $(INST_MANUALDIR)/INSTALL.pdf tmp/$(SRCDIR)
	rsync -auv --delete $(INST_MANUALDIR)/INSTALL.html tmp/$(SRCDIR)

	#make tarball
	# XXX NOTE: Problem: should use bin/make_tarball.sh
	# Furthermore, this script should NOT modify the contents
	# of $(SRCDIR) but rather use the --exclude feature to get rid of
	# indo/ and obsolete/ sundirectories in the tarball!
	cd tmp; sh ../bin/make_tar_file.sh nmag-$(NSIM_VERSION)
	mv tmp/nmag-$(NSIM_VERSION).tar.gz output/$(NSIM_VERSION)/download/

manuals: installation-manual nsim
	#copy to final destination
	rsync -auv tmp/nsim/interface/nmag/manual/* output/$(NSIM_VERSION)/manual
	rsync -auv $(INST_MANUALDIR)/INSTALL input/$(NSIM_VERSION)/install/_a_INSTALL


debian-package: nsim manuals fetchtrunk
	rsync -av --delete --exclude '*~' --exclude '.svn' tmp/nsim/interface/* debian/packages/nsim/interface/
	cp -a tmp/nsim/bin/n* debian/packages/nsim/bin/
	cp debian/adjustments/* debian/packages/nsim/bin/
	bin/svnversion-to-debian-changelog.pl $(DEBVERSION)
	cp -a tmp/nsim/pyfem3/pyfem3 debian/packages/nsim/bin/pyfem
	cd debian/packages/nsim; debuild -us -uc
	mv debian/packages/nsim_*.{dsc,changes,deb,tar.gz} debian/web/
	cd debian/web; make

# NOTE: not adjusted yet:

web-publish: update-0.1 update-devel debian-package
	rm -rf output/debian
	rsync -av debian/web/debian/ output/debian/
	rsync -avz --exclude '.svn' --delete -e ssh output/* www-data@$(WEBSERVER):/var/local/www/virtual-hosts/nmag/webroot/nmag/


# XXX NOTE: add .PHONY line!
